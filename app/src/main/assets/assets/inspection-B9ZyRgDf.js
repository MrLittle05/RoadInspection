import"./modulepreload-polyfill-B5Qt9EMX.js";const l={totalDistance:null,address:null,gps:null,time:null,gpsLevel:null,netLevel:null,lastPhoto:null,iriCanvas:null},w={timeOffset:0},r={maxDistance:500,dataQueue:[],currentTotalDist:0},h={initElements:()=>{l.totalDistance=document.getElementById("total-dist"),l.address=document.getElementById("address"),l.gps=document.getElementById("gps-raw"),l.time=document.getElementById("time"),l.gpsLevel=document.getElementById("gps-accuracy"),l.netLevel=document.getElementById("net-strength"),l.lastPhoto=document.getElementById("last-photo"),l.iriCanvas=document.getElementById("iri-canvas")},updateTotalDistance:e=>{e!=null&&(l.totalDistance.innerText=(e/1e3).toFixed(3))},updatePosition:(e,t)=>{const n=e?e>0?"N":"S":"",o=(Math.abs(e)||0).toFixed(6),d=t?t>0?"E":"W":"",c=(Math.abs(t)||0).toFixed(6);l.gps.innerText=`${n}:${o}  ${d}:${c}`},updateTimeOffset:e=>{(e!==void 0||e!==null)&&(w.timeOffset=e)},updateTime:e=>{const t=Date.now()+e,n=new Date(t),o=n.getFullYear()+"/"+String(n.getMonth()+1).padStart(2,"0")+"/"+String(n.getDate()).padStart(2,"0"),d=String(n.getHours()).padStart(2,"0")+":"+String(n.getMinutes()).padStart(2,"0")+":"+String(n.getSeconds()).padStart(2,"0");l.time.innerText=`${o}  ${d}`},updateAddress:e=>{l.address.innerText=e},updateGpsLevel:e=>{const t=["无","弱","较弱","较强","强"][e]||"无";l.gpsLevel.innerText=t},updateNetLevel:e=>{const t=["无","弱","较弱","较强","强"][e]||"无";l.netLevel.innerText=t},updateLatestPhoto:e=>{const t=l.lastPhoto;t&&(t.src=e,t.style.display="block")},updateIriData:(e,t)=>{if(!l.iriCanvas)return;r.currentTotalDist+=t,r.dataQueue.push({dist:r.currentTotalDist,val:e});const n=r.currentTotalDist-r.maxDistance;for(;r.dataQueue.length>0&&r.dataQueue[0].dist<n;)r.dataQueue.shift();I()},resetIriChart:()=>{r.dataQueue=[],r.currentTotalDist=0,l.iriCanvas&&I()}};function I(){const e=l.iriCanvas;if(!e)return;const t=e.getContext("2d"),n=r.dataQueue;t.clearRect(0,0,e.width,e.height);const o={top:20,right:20,bottom:30,left:40},d=e.width-o.left-o.right,c=e.height-o.top-o.bottom,g=9,p=u=>{const m=Math.max(0,r.currentTotalDist-r.maxDistance),f=Math.max(r.maxDistance,r.currentTotalDist),y=(u-m)/(f-m);return o.left+y*d},v=u=>{const f=Math.min(Math.max(u,0),g)/g;return o.top+c-f*c};t.save(),t.fillStyle="white",t.font="bold 14px sans-serif",t.textAlign="right",t.textBaseline="middle",t.shadowColor="rgba(0, 0, 0, 0.8)",t.shadowBlur=4,t.shadowOffsetX=1,t.shadowOffsetY=1,[0,2,4,6,8].forEach(u=>{const m=v(u);t.beginPath(),t.strokeStyle="rgba(255, 255, 255, 0.5)",t.lineWidth=1,t.setLineDash([6,4]),t.moveTo(o.left,m),t.lineTo(o.left+d,m),t.stroke(),t.setLineDash([]),t.fillText(u.toString(),o.left-8,m)}),t.textAlign="center",t.textBaseline="top";const B=Math.max(0,r.currentTotalDist-r.maxDistance),L=Math.max(r.maxDistance,r.currentTotalDist),E=(B/1e3).toFixed(1)+"km";t.fillText(E,o.left,o.top+c+8);const x=(L/1e3).toFixed(1)+"km";if(t.fillText(x,o.left+d,o.top+c+8),t.strokeStyle="white",t.lineWidth=2,t.setLineDash([]),t.beginPath(),t.moveTo(o.left,o.top),t.lineTo(o.left,o.top+c),t.lineTo(o.left+d,o.top+c),t.stroke(),t.restore(),!(n.length<2)){t.lineWidth=3,t.lineCap="round",t.lineJoin="round",t.setLineDash([]);for(let u=0;u<n.length-1;u++){const m=n[u],f=n[u+1];t.beginPath(),t.moveTo(p(m.dist),v(m.val)),t.lineTo(p(f.dist),v(f.val));const y=(m.val+f.val)/2;t.strokeStyle=b(y),t.stroke()}}}function b(e){return e<=2?"#00E676":e<=4?"#FFFF00":e<=6?"#FF9100":e<=8?"#FF1744":"#D500F9"}window.JSBridge={updateDashboard:function(e){try{const t=JSON.parse(e);h.updateTotalDistance(t.totalDistance),h.updateTimeOffset(t.timeDiff),h.updatePosition(t.lat,t.lng)}catch(t){console.error("Data parse error",t)}},updateGpsLevel:function(e){h.updateGpsLevel(e)},updateNetLevel:function(e){h.updateNetLevel(e)},updateAddress:function(e){h.updateAddress(e)},updateLatestPhoto:function(e){h.updateLatestPhoto(e)},updateIriData:function(e,t){h.updateIriData(e,t)}};const i={infoBtn:null,zoom1Btn:null,zoom05Btn:null,modePhotoBtn:null,modeVideoBtn:null,galleryBtn:null,shutterBtn:null,aiBtn:null,timer:null,distValRow:null},s={currentMode:"video",isRecording:!1,recordSeconds:0,currentRotationState:0,timerInterval:null};window.AndroidNative||(window.AndroidNative={startInspection:()=>console.log("Mock: Start Inspection"),stopInspection:()=>console.log("Mock: Stop Inspection"),manualCapture:()=>console.log("Mock: Take Photo"),showToast:e=>console.log("Toast: "+e),openGallery:e=>console.log("Open Gallery: "+e)});const a={initElements:()=>{i.infoBtn=document.getElementById("btn-info"),i.zoom1Btn=document.getElementById("btn-zoom-1"),i.zoom05Btn=document.getElementById("btn-zoom-05"),i.modePhotoBtn=document.getElementById("btn-mode-photo"),i.modeVideoBtn=document.getElementById("btn-mode-video"),i.galleryBtn=document.getElementById("btn-gallery"),i.shutterBtn=document.getElementById("btn-shutter"),i.aiBtn=document.getElementById("btn-ai"),i.timer=document.getElementById("timer"),i.distValRow=document.querySelector(".dist-val-row")},bind:(e,t)=>{switch(e){case"info":i.infoBtn.addEventListener("click",t);break;case"zoom1":i.zoom1Btn.addEventListener("click",t);break;case"zoom05":i.zoom05Btn.addEventListener("click",t);break;case"modePhoto":i.modePhotoBtn.addEventListener("click",t);break;case"modeVideo":i.modeVideoBtn.addEventListener("click",t);break;case"gallery":i.galleryBtn.addEventListener("click",t);break;case"shutter":i.shutterBtn.addEventListener("click",t);break;case"ai":i.aiBtn.addEventListener("click",t);break;case"rotation":window.addEventListener("deviceorientation",t)}},toggleDisplayInfo:()=>{const e=document.querySelector(".text-info");e.classList.contains("info-hidden")?e.classList.remove("info-hidden"):e.classList.add("info-hidden")},setZoom:e=>{document.querySelectorAll(".zoom-btn").forEach(n=>n.classList.remove("active"));const t=e===1?"btn-zoom-1":"btn-zoom-05";document.getElementById(t).classList.add("active"),window.AndroidNative.setZoom(e)},switchMode:e=>{if(s.isRecording)return;s.currentMode=e,document.querySelectorAll(".mode-item").forEach(n=>n.classList.remove("active")),document.getElementById("btn-mode-"+e).classList.add("active");const t=document.getElementById("shutter-btn");e==="photo"?(i.timer.classList.add("hidden"),t.classList.add("photo-mode")):(i.timer.classList.remove("hidden"),t.classList.remove("photo-mode"))},handleShutter:()=>{if(s.currentMode==="photo")window.AndroidNative.manualCapture(),D();else if(s.isRecording)k();else{const e=Object.fromEntries(new URLSearchParams(window.location.search));T(e.taskName,e.userId)}},toggleAI:()=>{window.AndroidNative.showToast("AI 算法配置中")},openGallery:()=>{window.AndroidNative.openGallery("all")},handleOrientation:e=>{let{beta:t,gamma:n}=e;const o=M(t,n,s.currentRotationState);if(o!==s.currentRotationState){s.currentRotationState=o;const d=document.querySelector(".layout-root");d.classList.remove("mode-portrait","mode-tilt-left","mode-tilt-right"),s.currentRotationState===0?(d.classList.add("mode-portrait"),i.distValRow.style.flexDirection="row"):s.currentRotationState===90?(d.classList.add("mode-tilt-left"),i.distValRow.style.flexDirection="row-reverse"):s.currentRotationState===-90&&(d.classList.add("mode-tilt-right"),i.distValRow.style.flexDirection="row"),document.querySelectorAll(".rotatable").forEach(c=>{c.style.transform=`rotate(${s.currentRotationState}deg)`})}}};function D(){const e=document.querySelector(".shutter-inner");e.style.transform="scale(0.5)",setTimeout(()=>e.style.transform="scale(1)",100);const t=document.createElement("div");t.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:black;opacity:0.6;z-index:999;transition:opacity 0.2s;",document.body.appendChild(t),setTimeout(()=>t.style.opacity=0,50),setTimeout(()=>t.remove(),250)}function T(e,t){if(!t){window.AndroidNative.showToast("请先登录，再开始巡检！");return}s.isRecording=!0,document.getElementById("shutter-btn").classList.add("recording"),i.timer&&i.timer.classList.add("active"),window.AndroidNative.startInspection(e,t),s.recordSeconds=0,S(),s.timerInterval=setInterval(()=>{s.recordSeconds++,S()},1e3),h.resetIriChart();const n=document.getElementById("iri-canvas");n&&n.classList.remove("hidden")}function k(){s.isRecording=!1,document.getElementById("shutter-btn").classList.remove("recording"),i.timer&&i.timer.classList.remove("active"),window.AndroidNative.stopInspection(),s.recordSeconds=0,S(),clearInterval(s.timerInterval);const e=document.getElementById("iri-canvas");e&&e.classList.add("hidden")}function S(){const e=Math.floor(s.recordSeconds/3600).toString().padStart(2,"0"),t=Math.floor(s.recordSeconds%3600/60).toString().padStart(2,"0"),n=(s.recordSeconds%60).toString().padStart(2,"0");i.timer.innerText=`${e}:${t}:${n}`}function M(e,t,n){e>90&&(e=180-e),e<-90&&(e=-180-e);const o=Math.abs(t),d=Math.abs(e);if(d<10&&o<10)return n;let c=n;const g=n===90||n===-90,p=d>30;return g?p&&(d>o+15?c=0:(t>20&&(c=-90),t<-20&&(c=90))):o>d+15&&(c=t>0?-90:90),c}document.addEventListener("DOMContentLoaded",R());function R(){a.initElements(),h.initElements(),A(),setInterval(()=>{h.updateTime(w.timeOffset)},1e3)}function A(){a.bind("info",a.toggleDisplayInfo),a.bind("zoom1",()=>a.setZoom(1)),a.bind("zoom05",()=>a.setZoom(.5)),a.bind("modePhoto",()=>a.switchMode("photo")),a.bind("modeVideo",()=>a.switchMode("video")),a.bind("gallery",a.openGallery),a.bind("shutter",a.handleShutter),a.bind("ai",a.toggleAI),a.bind("rotation",a.handleOrientation)}
