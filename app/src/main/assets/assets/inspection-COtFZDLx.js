import"./modulepreload-polyfill-B5Qt9EMX.js";const l={totalDistance:null,address:null,gps:null,time:null,gpsLevel:null,netLevel:null,lastPhoto:null,iriCanvas:null},w={timeOffset:0},d={maxDistance:500,dataQueue:[],currentTotalDist:0},u={initElements:()=>{l.totalDistance=document.getElementById("total-dist"),l.address=document.getElementById("address"),l.gps=document.getElementById("gps-raw"),l.time=document.getElementById("time"),l.gpsLevel=document.getElementById("gps-accuracy"),l.netLevel=document.getElementById("net-strength"),l.lastPhoto=document.getElementById("last-photo"),l.iriCanvas=document.getElementById("iri-canvas")},restoreState:t=>{const e=t.distance||0;u.updateTotalDistance(e),d.currentTotalDist=e,d.dataQueue=[]},updateTotalDistance:t=>{t!=null&&(l.totalDistance.innerText=(t/1e3).toFixed(3))},updatePosition:(t,e)=>{const o=t?t>0?"N":"S":"",s=(Math.abs(t)||0).toFixed(6),r=e?e>0?"E":"W":"",c=(Math.abs(e)||0).toFixed(6);l.gps.innerText=`${o}:${s}  ${r}:${c}`},updateTimeOffset:t=>{(t!==void 0||t!==null)&&(w.timeOffset=t)},updateTime:t=>{const e=Date.now()+t,o=new Date(e),s=o.getFullYear()+"/"+String(o.getMonth()+1).padStart(2,"0")+"/"+String(o.getDate()).padStart(2,"0"),r=String(o.getHours()).padStart(2,"0")+":"+String(o.getMinutes()).padStart(2,"0")+":"+String(o.getSeconds()).padStart(2,"0");l.time.innerText=`${s}  ${r}`},updateAddress:t=>{l.address.innerText=t},updateGpsLevel:t=>{const e=["无","弱","较弱","较强","强"][t]||"无";l.gpsLevel.innerText=e},updateNetLevel:t=>{const e=["无","弱","较弱","较强","强"][t]||"无";l.netLevel.innerText=e},updateLatestPhoto:t=>{const e=l.lastPhoto;e&&(e.src=t,e.style.display="block")},updateIriData:(t,e)=>{if(!l.iriCanvas)return;d.currentTotalDist+=e,d.dataQueue.push({dist:d.currentTotalDist,val:t});const o=d.currentTotalDist-d.maxDistance;for(;d.dataQueue.length>0&&d.dataQueue[0].dist<o;)d.dataQueue.shift();S()},resetIriChart:()=>{d.dataQueue=[],d.currentTotalDist=0,l.iriCanvas&&S()}};function S(){const t=l.iriCanvas;if(!t)return;const e=t.getContext("2d"),o=d.dataQueue;e.clearRect(0,0,t.width,t.height);const s={top:20,right:20,bottom:30,left:40},r=t.width-s.left-s.right,c=t.height-s.top-s.bottom,f=9,g=m=>{const h=Math.max(0,d.currentTotalDist-d.maxDistance),p=Math.max(d.maxDistance,d.currentTotalDist),E=(m-h)/(p-h);return s.left+E*r},y=m=>{const p=Math.min(Math.max(m,0),f)/f;return s.top+c-p*c};e.save(),e.fillStyle="white",e.font="bold 14px sans-serif",e.textAlign="right",e.textBaseline="middle",e.shadowColor="rgba(0, 0, 0, 0.8)",e.shadowBlur=4,e.shadowOffsetX=1,e.shadowOffsetY=1,[0,2,4,6,8].forEach(m=>{const h=y(m);e.beginPath(),e.strokeStyle="rgba(255, 255, 255, 0.5)",e.lineWidth=1,e.setLineDash([6,4]),e.moveTo(s.left,h),e.lineTo(s.left+r,h),e.stroke(),e.setLineDash([]),e.fillText(m.toString(),s.left-8,h)}),e.textAlign="center",e.textBaseline="top";const I=Math.max(0,d.currentTotalDist-d.maxDistance),x=Math.max(d.maxDistance,d.currentTotalDist),b=(I/1e3).toFixed(1)+"km";e.fillText(b,s.left,s.top+c+8);const D=(x/1e3).toFixed(1)+"km";if(e.fillText(D,s.left+r,s.top+c+8),e.strokeStyle="white",e.lineWidth=2,e.setLineDash([]),e.beginPath(),e.moveTo(s.left,s.top),e.lineTo(s.left,s.top+c),e.lineTo(s.left+r,s.top+c),e.stroke(),e.restore(),!(o.length<2)){e.lineWidth=3,e.lineCap="round",e.lineJoin="round",e.setLineDash([]);for(let m=0;m<o.length-1;m++){const h=o[m],p=o[m+1];e.beginPath(),e.moveTo(g(h.dist),y(h.val)),e.lineTo(g(p.dist),y(p.val));const E=(h.val+p.val)/2;e.strokeStyle=T(E),e.stroke()}}}function T(t){return t<=2?"#00E676":t<=4?"#FFFF00":t<=6?"#FF9100":t<=8?"#FF1744":"#D500F9"}const n={infoBtn:null,zoom1Btn:null,zoom05Btn:null,modePhotoBtn:null,modeVideoBtn:null,galleryBtn:null,shutterBtn:null,aiBtn:null,timer:null,distValRow:null,galleryWrapper:null,pauseWrapper:null,iconPause:null,iconResume:null,exitModal:null,btnModalResume:null,btnModalSaveExit:null},i={currentMode:"video",isRecording:!1,isPaused:!1,recordSeconds:0,currentRotationState:0,timerInterval:null},a={initElements:()=>{n.infoBtn=document.getElementById("btn-info"),n.zoom1Btn=document.getElementById("btn-zoom-1"),n.zoom05Btn=document.getElementById("btn-zoom-05"),n.modePhotoBtn=document.getElementById("btn-mode-photo"),n.modeVideoBtn=document.getElementById("btn-mode-video"),n.galleryBtn=document.getElementById("btn-gallery"),n.shutterBtn=document.getElementById("btn-shutter"),n.aiBtn=document.getElementById("btn-ai"),n.timer=document.getElementById("timer"),n.distValRow=document.querySelector(".dist-val-row"),n.galleryWrapper=document.getElementById("gallery-wrapper"),n.pauseWrapper=document.getElementById("pause-wrapper"),n.iconPause=document.getElementById("icon-pause"),n.iconResume=document.getElementById("icon-resume"),n.exitModal=document.getElementById("exit-modal"),n.btnModalResume=document.getElementById("btn-modal-resume"),n.btnModalSaveExit=document.getElementById("btn-modal-save-exit")},initJSBridgeCallback:()=>{window.JSBridge&&window.JSBridge.registerBackPressHandler(a.onBackProceed)},bind:(t,e)=>{switch(t){case"info":n.infoBtn.addEventListener("click",e);break;case"zoom1":n.zoom1Btn.addEventListener("click",e);break;case"zoom05":n.zoom05Btn.addEventListener("click",e);break;case"modePhoto":n.modePhotoBtn.addEventListener("click",e);break;case"modeVideo":n.modeVideoBtn.addEventListener("click",e);break;case"gallery":n.galleryBtn.addEventListener("click",e);break;case"shutter":n.shutterBtn.addEventListener("click",e);break;case"ai":n.aiBtn.addEventListener("click",e);break;case"rotation":window.addEventListener("deviceorientation",e);break;case"resume":n.btnModalResume.addEventListener("click",e);break;case"saveExit":n.btnModalSaveExit.addEventListener("click",e);break}},handleGalleryClick:()=>{i.isRecording?R():P()},toggleDisplayInfo:()=>{const t=document.querySelector(".text-info");t.classList.contains("info-hidden")?t.classList.remove("info-hidden"):t.classList.add("info-hidden")},setZoom:t=>{document.querySelectorAll(".zoom-btn").forEach(o=>o.classList.remove("active"));const e=t===1?"btn-zoom-1":"btn-zoom-05";document.getElementById(e).classList.add("active"),window.AndroidNative.setZoom(t)},switchMode:t=>{if(i.isRecording)return;i.currentMode=t,document.querySelectorAll(".mode-item").forEach(o=>o.classList.remove("active")),document.getElementById("btn-mode-"+t).classList.add("active");const e=document.getElementById("shutter-btn");t==="photo"?(n.timer.classList.add("hidden"),e.classList.add("photo-mode")):(n.timer.classList.remove("hidden"),e.classList.remove("photo-mode"))},handleShutter:()=>{if(i.currentMode==="photo")window.AndroidNative.manualCapture(),M();else if(i.isRecording)k(),setTimeout(()=>{window.AndroidNative.stopInspectionActivity()},1e3);else{const t=Object.fromEntries(new URLSearchParams(window.location.search));A(t.taskName,t.userId)}},toggleAI:()=>{window.AndroidNative.showToast("AI 算法配置中")},handleOrientation:t=>{let{beta:e,gamma:o}=t;const s=N(e,o,i.currentRotationState);if(s!==i.currentRotationState){i.currentRotationState=s;const r=document.querySelector(".layout-root");r.classList.remove("mode-portrait","mode-tilt-left","mode-tilt-right"),i.currentRotationState===0?(r.classList.add("mode-portrait"),n.distValRow.style.flexDirection="row"):i.currentRotationState===90?(r.classList.add("mode-tilt-left"),n.distValRow.style.flexDirection="row-reverse"):i.currentRotationState===-90&&(r.classList.add("mode-tilt-right"),n.distValRow.style.flexDirection="row"),document.querySelectorAll(".rotatable").forEach(c=>{c.style.transform=`rotate(${i.currentRotationState}deg)`})}},onBackProceed:()=>{i.isRecording?a.showExitModal():window.AndroidNative.stopInspectionActivity()},showExitModal:()=>{n.exitModal.classList.remove("hidden")},dismissExitModal:()=>{n.exitModal.classList.add("hidden")},handleSaveAndExit:()=>{a.dismissExitModal(),window.AndroidNative.saveInspectionState(),setTimeout(()=>{window.AndroidNative.stopInspectionActivity()},800)},restoreState:t=>{i.isRecording=!0,i.isPaused=!0,i.recordSeconds=t.seconds||0,v(),B(),n.galleryWrapper.classList.add("hidden"),n.pauseWrapper.classList.remove("hidden"),n.iconPause.classList.add("hidden"),n.iconResume.classList.remove("hidden"),document.getElementById("shutter-btn").classList.add("recording"),n.timer&&n.timer.classList.add("active")}};function R(){i.isPaused=!i.isPaused,i.isPaused?(n.iconPause.classList.add("hidden"),n.iconResume.classList.remove("hidden"),window.AndroidNative.pauseInspection(),console.log("Notify Android to PAUSE inspection")):(n.iconPause.classList.remove("hidden"),n.iconResume.classList.add("hidden"),window.AndroidNative.resumeInspection(),console.log("Notify Android to RESUME inspection"))}function B(){i.timerInterval&&clearInterval(i.timerInterval),i.timerInterval=setInterval(()=>{i.isRecording&&!i.isPaused&&(i.recordSeconds++,v())},1e3)}function P(){window.AndroidNative.openGallery("all")}function M(){const t=document.querySelector(".shutter-inner");t.style.transform="scale(0.5)",setTimeout(()=>t.style.transform="scale(1)",100);const e=document.createElement("div");e.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:black;opacity:0.6;z-index:999;transition:opacity 0.2s;",document.body.appendChild(e),setTimeout(()=>e.style.opacity=0,50),setTimeout(()=>e.remove(),250)}function A(t,e){if(!e){window.AndroidNative.showToast("请先登录，再开始巡检！");return}i.isRecording=!0,i.isPaused=!1,document.getElementById("shutter-btn").classList.add("recording"),n.timer&&n.timer.classList.add("active"),n.galleryWrapper.classList.add("hidden"),n.pauseWrapper.classList.remove("hidden"),n.iconPause.classList.remove("hidden"),n.iconResume.classList.add("hidden"),window.AndroidNative.startInspection(t,e),i.recordSeconds=0,v(),B(),u.resetIriChart();const o=document.getElementById("iri-canvas");o&&o.classList.remove("hidden")}function k(){i.isRecording=!1,document.getElementById("shutter-btn").classList.remove("recording"),n.timer&&n.timer.classList.remove("active"),n.pauseWrapper.classList.add("hidden"),n.galleryWrapper.classList.remove("hidden"),window.AndroidNative.stopInspection(),i.recordSeconds=0,v(),clearInterval(i.timerInterval);const t=document.getElementById("iri-canvas");t&&t.classList.add("hidden")}function v(){const t=Math.floor(i.recordSeconds/3600).toString().padStart(2,"0"),e=Math.floor(i.recordSeconds%3600/60).toString().padStart(2,"0"),o=(i.recordSeconds%60).toString().padStart(2,"0");n.timer.innerText=`${t}:${e}:${o}`}function N(t,e,o){t>90&&(t=180-t),t<-90&&(t=-180-t);const s=Math.abs(e),r=Math.abs(t);if(r<10&&s<10)return o;let c=o;const f=o===90||o===-90,g=r>30;return f?g&&(r>s+15?c=0:(e>20&&(c=-90),e<-20&&(c=90))):s>r+15&&(c=e>0?-90:90),c}let L=null;window.JSBridge={updateDashboard:function(t){try{const e=JSON.parse(t);u.updateTotalDistance(e.totalDistance),u.updateTimeOffset(e.timeDiff),u.updatePosition(e.lat,e.lng)}catch(e){console.error("Data parse error",e)}},updateGpsLevel:function(t){u.updateGpsLevel(t)},updateNetLevel:function(t){u.updateNetLevel(t)},updateAddress:function(t){u.updateAddress(t)},updateLatestPhoto:function(t){u.updateLatestPhoto(t)},updateIriData:function(t,e){u.updateIriData(t,e)},registerBackPressHandler:function(t){L=t},onNativeBackPressed:function(){L?L():window.AndroidNative&&window.AndroidNative.stopInspectionActivity()},onRestoreState:function(t){u.restoreState(t),a.restoreState(t)}};document.addEventListener("DOMContentLoaded",C());function C(){a.initElements(),a.initJSBridgeCallback(),u.initElements(),z(),setInterval(()=>{u.updateTime(w.timeOffset)},1e3)}function z(){a.bind("info",a.toggleDisplayInfo),a.bind("zoom1",()=>a.setZoom(1)),a.bind("zoom05",()=>a.setZoom(.5)),a.bind("modePhoto",()=>a.switchMode("photo")),a.bind("modeVideo",()=>a.switchMode("video")),a.bind("gallery",a.handleGalleryClick),a.bind("shutter",a.handleShutter),a.bind("ai",a.toggleAI),a.bind("rotation",a.handleOrientation),a.bind("resume",a.dismissExitModal),a.bind("saveExit",a.handleSaveAndExit)}
